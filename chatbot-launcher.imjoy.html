<docs>
[TODO: write documentation for this plugin.]
</docs>

<config lang="json">
{
  "name": "Chatbot launcher",
  "type": "web-worker",
  "tags": [],
  "ui": "",
  "version": "0.1.0",
  "cover": "",
  "description": "Launch chatbot with bioengine-web-client support",
  "icon": "extension",
  "inputs": null,
  "outputs": null,
  "api_version": "0.1.8",
  "env": "",
  "permissions": [],
  "requirements": [],
  "dependencies": []
}
</config>

<script lang="javascript">
class ImJoyPlugin {
  async setup() {
    api.log('initialized')
  }

  async run(ctx) {
    const chatbot = await api.createWindow({
      src: "https://staging.chat.bioimage.io/public/apps/bioimageio-chatbot-client/index",
      name: "BioImage.IO Chatbot",
    });
    await chatbot.registerExtension({
      _rintf: true,
      name: "runImageJMacro",
      description: "Run a macro in ImageJ.JS",
      async get_schema() {
        return {
          type: "object",
          title: "RunImageJMacro",
          description: "Run a macro in ImageJ.JS",
          properties: {
            macro: {
              type: "string",
              description: "The macro to run",
            },
            args: {
              type: "object",
              description: "Arguments for the macro",
            },
          },
        };
      },
      async execute(config) {
        let ij = await api.getWindow("ImageJ.JS");
        if (!ij) {
          ij = await api.createWindow({
            src: "https://ij.imjoy.io",
            name: "ImageJ.JS",
          });
        }
        try {
          const result = await ij.runMacro(config["macro"], config["args"]);
          return result;
        } catch (e) {
          console.error(e);
          return e.toString();
        }
      },
    });

    await chatbot.registerExtension({
      _rintf: true,
      name: "runBioengineClient",
      description: "Run bioengine web client",
      async get_schema() {
        return {
          type: "object",
          title: "RunBioengineClient",
          description: "Run bioengine web client",
          properties: {
            model_name: {
              type: "string",
              description: "The model name to run",
            },
            parameters: {
              type: "string",
              description: `Parameters for the model, structured as a JSON object. For example, use {"model_type": "cyto", "diameter": 30} for a cyto model with a diameter parameter. The keys should be string identifiers of the parameters, and the values should be their corresponding settings. The structure and content of this object can vary depending on the specific model being used. Make sure to adhere to the expected data types and value ranges for each parameter.`
            }
          },
        };
      },
      async execute(config) {
        let client = await api.getWindow("bioengine-web-client");
        if (!client) {
          client = await api.createWindow({
            src: "https://bioimage-io.github.io/bioengine-web-client/",
            name: "bioengine-web-client",
          });
          await client.waitForReady();
        }
        await client.setModel(config["model_name"]);
        const params = config?.parameters;
        if (params) {
          const paramsObj = JSON.parse(params)
          await client.setParameters(paramsObj);
        }
        await client.runModel();
      },
    });
  }
}

api.export(new ImJoyPlugin())
</script>
